# Comprehensive TDD Plan - Personal Testimony Builder

## Overview

This document outlines the complete Test-Driven Development (TDD) approach for all features in the Personal Testimony Builder application. Each feature includes detailed test cases organized by layer (Domain, Infrastructure, API, Components).

## Test Organization Structure

```
testimony-builder/
├── __tests__/                    # Test utilities and setup
│   ├── setup.ts                  # Test configuration
│   ├── fixtures/                 # Test data fixtures
│   │   ├── testimonies.ts       # Testimony test data
│   │   ├── users.ts             # User test data
│   │   └── subscriptions.ts     # Subscription test data
│   └── mocks/                    # Mock implementations
│       ├── supabase.ts          # Supabase mocks
│       ├── stripe.ts             # Stripe mocks
│       └── ai.ts                 # AI provider mocks
├── domain/                       # Domain layer tests
│   ├── testimony/
│   │   ├── __tests__/
│   │   │   ├── TestimonyService.test.ts
│   │   │   └── TestimonyRepository.test.ts
│   ├── user/
│   │   └── __tests__/
│   │       └── UserService.test.ts
│   └── subscription/
│       └── __tests__/
│           └── SubscriptionService.test.ts
├── infrastructure/               # Infrastructure layer tests
│   ├── ai/
│   │   └── __tests__/
│   │       ├── AiService.test.ts
│   │       └── providers/
│   │           ├── OpenAIProvider.test.ts
│   │           └── AnthropicProvider.test.ts
│   ├── export/
│   │   └── __tests__/
│   │       ├── ExportService.test.ts
│   │       └── providers/
│   │           └── PDFProvider.test.ts
│   ├── payment/
│   │   └── __tests__/
│   │       ├── PaymentService.test.ts
│   │       └── providers/
│   │           └── StripeProvider.test.ts
│   └── database/
│       └── __tests__/
│           └── SupabaseTestimonyRepository.test.ts
├── app/                          # API route tests
│   └── api/
│       └── __tests__/
│           ├── auth/
│           │   └── magic-link.test.ts
│           ├── testimonies.test.ts
│           ├── ai.test.ts
│           ├── export.test.ts
│           ├── gallery.test.ts
│           └── payments/
│               └── webhook.test.ts
└── components/                  # Component tests (co-located)
    ├── __tests__/
    │   ├── TestimonyEditor.test.tsx
    │   ├── TestimonyPreview.test.tsx
    │   ├── LoginForm.test.tsx
    │   └── frameworks/
    │       ├── BeforeEncounterAfter.test.tsx
    │       ├── LifeTimeline.test.tsx
    │       ├── SeasonsOfGrowth.test.tsx
    │       └── FreeFormNarrative.test.tsx
```

## Feature 1: Magic Link Authentication

### Domain Tests (`domain/user/__tests__/UserService.test.ts`)

```typescript
describe('UserService - Magic Link Authentication', () => {
  describe('sendMagicLink', () => {
    it('should send magic link email when valid email provided', async () => {
      const email = 'user@example.com';
      const mockEmailService = { sendMagicLink: jest.fn().mockResolvedValue(true) };
      await userService.sendMagicLink(email);
      expect(mockEmailService.sendMagicLink).toHaveBeenCalledWith(email);
    });
    
    it('should throw error when email is invalid', async () => {
      await expect(userService.sendMagicLink('not-an-email')).rejects.toThrow('Invalid email');
    });
    
    it('should throw error when email is empty', async () => {
      await expect(userService.sendMagicLink('')).rejects.toThrow('Email required');
    });
    
    it('should throw error when rate limit exceeded', async () => {
      mockRateLimiter.check.mockResolvedValue({ allowed: false, remaining: 0 });
      await expect(userService.sendMagicLink('user@example.com')).rejects.toThrow('Rate limit exceeded');
    });
  });
  
  describe('verifyMagicLinkToken', () => {
    it('should authenticate user when valid token provided', async () => {
      const token = 'valid-token';
      const expectedUser = { id: 'user-123', email: 'user@example.com' };
      mockSupabase.auth.verifyOtp.mockResolvedValue({ user: expectedUser });
      const user = await userService.verifyMagicLinkToken(token);
      expect(user).toEqual(expectedUser);
    });
    
    it('should throw error when token is invalid', async () => {
      mockSupabase.auth.verifyOtp.mockResolvedValue({ user: null, error: { message: 'Invalid token' } });
      await expect(userService.verifyMagicLinkToken('invalid-token')).rejects.toThrow('Invalid token');
    });
    
    it('should throw error when token is expired', async () => {
      mockSupabase.auth.verifyOtp.mockResolvedValue({ user: null, error: { message: 'Token expired' } });
      await expect(userService.verifyMagicLinkToken('expired-token')).rejects.toThrow('Token expired');
    });
  });
});
```

### API Route Tests (`app/api/__tests__/auth/magic-link.test.ts`)

```typescript
describe('POST /api/auth/send-magic-link', () => {
  it('should return 200 when valid email provided', async () => {
    const response = await request(app)
      .post('/api/auth/send-magic-link')
      .send({ email: 'user@example.com' })
      .expect(200);
    expect(response.body).toEqual({ success: true, message: 'Magic link sent' });
  });
  
  it('should return 400 when email is invalid', async () => {
    await request(app)
      .post('/api/auth/send-magic-link')
      .send({ email: 'invalid-email' })
      .expect(400);
  });
  
  it('should return 429 when rate limit exceeded', async () => {
    mockRateLimiter.check.mockResolvedValue({ allowed: false });
    await request(app)
      .post('/api/auth/send-magic-link')
      .send({ email: 'user@example.com' })
      .expect(429);
  });
  
  it('should return 401 when token is invalid', async () => {
    await request(app)
      .get('/api/auth/callback')
      .query({ token: 'invalid-token' })
      .expect(401);
  });
});
```

### Component Tests (`components/__tests__/LoginForm.test.tsx`)

```typescript
describe('LoginForm', () => {
  it('should render email input field', () => {
    render(<LoginForm />);
    expect(screen.getByLabelText(/email/i)).toBeInTheDocument();
  });
  
  it('should show error when email is invalid', async () => {
    const user = userEvent.setup();
    render(<LoginForm />);
    const emailInput = screen.getByLabelText(/email/i);
    await user.type(emailInput, 'invalid-email');
    await user.click(screen.getByRole('button', { name: /send magic link/i }));
    expect(await screen.findByText(/invalid email/i)).toBeInTheDocument();
  });
  
  it('should call sendMagicLink when form submitted with valid email', async () => {
    const mockSendMagicLink = jest.fn().mockResolvedValue({ success: true });
    const user = userEvent.setup();
    render(<LoginForm onSendMagicLink={mockSendMagicLink} />);
    await user.type(screen.getByLabelText(/email/i), 'user@example.com');
    await user.click(screen.getByRole('button', { name: /send magic link/i }));
    expect(mockSendMagicLink).toHaveBeenCalledWith('user@example.com');
  });
  
  it('should show success message after magic link sent', async () => {
    const mockSendMagicLink = jest.fn().mockResolvedValue({ success: true });
    const user = userEvent.setup();
    render(<LoginForm onSendMagicLink={mockSendMagicLink} />);
    await user.type(screen.getByLabelText(/email/i), 'user@example.com');
    await user.click(screen.getByRole('button', { name: /send magic link/i }));
    expect(await screen.findByText(/check your email/i)).toBeInTheDocument();
  });
});
```

## Feature 2: Testimony CRUD Operations

### Domain Tests (`domain/testimony/__tests__/TestimonyService.test.ts`)

**Create Testimony:**
- ✅ Should create testimony with valid data
- ✅ Should throw error when title is empty
- ✅ Should throw error when framework is invalid
- ✅ Should validate content structure matches framework
- ✅ Should set userId from authenticated user
- ✅ Should set created_at timestamp

**Get Testimony:**
- ✅ Should return testimony when user owns it
- ✅ Should throw error when user does not own testimony
- ✅ Should throw error when testimony does not exist

**Update Testimony:**
- ✅ Should update testimony when user owns it
- ✅ Should throw error when user does not own testimony
- ✅ Should validate updated content structure
- ✅ Should update updated_at timestamp

**Delete Testimony:**
- ✅ Should delete testimony when user owns it
- ✅ Should throw error when user does not own testimony
- ✅ Should also delete associated gallery entries

**List Testimonies:**
- ✅ Should return only testimonies owned by user
- ✅ Should return empty array when user has no testimonies
- ✅ Should support pagination
- ✅ Should support filtering by framework type

### Repository Tests (`infrastructure/database/__tests__/SupabaseTestimonyRepository.test.ts`)

- ✅ Should persist testimony to database
- ✅ Should return testimony from database
- ✅ Should return null when testimony not found
- ✅ Should update testimony in database
- ✅ Should delete testimony from database
- ✅ Should return all testimonies for user
- ✅ Should handle database errors gracefully

### API Route Tests (`app/api/__tests__/testimonies.test.ts`)

**POST /api/testimonies:**
- ✅ Should create testimony for authenticated user
- ✅ Should return 401 for unauthenticated requests
- ✅ Should return 400 when title is missing
- ✅ Should return 400 when framework is invalid
- ✅ Should return 400 when content structure is invalid

**GET /api/testimonies/:id:**
- ✅ Should return testimony when user owns it
- ✅ Should return 403 when user does not own testimony
- ✅ Should return 404 when testimony does not exist
- ✅ Should return 401 for unauthenticated requests

**PUT /api/testimonies/:id:**
- ✅ Should update testimony when user owns it
- ✅ Should return 403 when user does not own testimony
- ✅ Should return 400 when validation fails

**DELETE /api/testimonies/:id:**
- ✅ Should delete testimony when user owns it
- ✅ Should return 403 when user does not own testimony

**GET /api/testimonies:**
- ✅ Should return all testimonies for authenticated user
- ✅ Should support pagination query parameters
- ✅ Should support filtering by framework

### Component Tests (`components/__tests__/TestimonyEditor.test.tsx`)

- ✅ Should render framework selector
- ✅ Should render BeforeEncounterAfter form when framework selected
- ✅ Should render LifeTimeline form when framework selected
- ✅ Should render SeasonsOfGrowth form when framework selected
- ✅ Should render FreeFormNarrative form when framework selected
- ✅ Should call onSave with testimony data when form submitted
- ✅ Should show validation error when title is empty
- ✅ Should show validation error when required fields are missing
- ✅ Should auto-save draft periodically
- ✅ Should show save status indicator

## Feature 3: Framework Components

### BeforeEncounterAfter Tests (`components/__tests__/frameworks/BeforeEncounterAfter.test.tsx`)

- ✅ Should render all three sections (Before, Encounter, After)
- ✅ Should call onChange when user types in before section
- ✅ Should call onChange when user types in encounter section
- ✅ Should call onChange when user types in after section
- ✅ Should display existing values
- ✅ Should show character count for each section
- ✅ Should validate minimum content length

### LifeTimeline Tests (`components/__tests__/frameworks/LifeTimeline.test.tsx`)

- ✅ Should render add milestone button
- ✅ Should add milestone when add button clicked
- ✅ Should remove milestone when delete button clicked
- ✅ Should update milestone when user edits
- ✅ Should reorder milestones via drag and drop
- ✅ Should validate milestone data (age, event, impact)

### SeasonsOfGrowth Tests (`components/__tests__/frameworks/SeasonsOfGrowth.test.tsx`)

- ✅ Should render season sections
- ✅ Should add new season when button clicked
- ✅ Should remove season when delete clicked
- ✅ Should update season content when edited
- ✅ Should validate season structure

### FreeFormNarrative Tests (`components/__tests__/frameworks/FreeFormNarrative.test.tsx`)

- ✅ Should render rich text editor
- ✅ Should call onChange when content changes
- ✅ Should support formatting (bold, italic, etc.)
- ✅ Should display existing content
- ✅ Should show word count

## Feature 4: PDF Export

### Export Service Tests (`infrastructure/export/__tests__/ExportService.test.ts`)

- ✅ Should generate PDF from testimony data
- ✅ Should sanitize content before PDF generation
- ✅ Should handle all framework types
- ✅ Should format title correctly
- ✅ Should handle long content (page breaks)
- ✅ Should include metadata (date, framework type)

### PDF Provider Tests (`infrastructure/export/__tests__/providers/PDFProvider.test.ts`)

- ✅ Should generate PDF document
- ✅ Should format testimony content correctly
- ✅ Should handle special characters
- ✅ Should apply consistent styling
- ✅ Should generate table of contents for long testimonies

### API Route Tests (`app/api/__tests__/export.test.ts`)

- ✅ Should return PDF file when user owns testimony
- ✅ Should return 403 when user does not own testimony
- ✅ Should return 401 for unauthenticated requests
- ✅ Should return 429 when rate limit exceeded
- ✅ Should set correct content-type header
- ✅ Should set filename in content-disposition header

## Feature 5: AI Editing (Premium)

### AI Provider Interface Tests (`infrastructure/ai/__tests__/IAiProvider.test.ts`)

- ✅ Should generate editing suggestions
- ✅ Should handle rate limiting
- ✅ Should sanitize input before sending to AI
- ✅ Should handle API errors gracefully
- ✅ Should respect token limits

### AI Service Tests (`infrastructure/ai/__tests__/AiService.test.ts`)

- ✅ Should return suggestions from AI provider
- ✅ Should require premium subscription
- ✅ Should enforce rate limits
- ✅ Should sanitize input before sending to AI
- ✅ Should cache similar requests
- ✅ Should handle provider errors gracefully

### API Route Tests (`app/api/__tests__/ai.test.ts`)

- ✅ Should return AI suggestions for premium users
- ✅ Should return 402 when user does not have premium subscription
- ✅ Should return 403 when user does not own testimony
- ✅ Should return 429 when rate limit exceeded
- ✅ Should return 400 when prompt is empty
- ✅ Should return 400 when testimonyId is invalid

## Feature 6: Stripe Payments

### Payment Service Tests (`infrastructure/payment/__tests__/PaymentService.test.ts`)

**Create Checkout:**
- ✅ Should create Stripe checkout session
- ✅ Should include user ID in session metadata
- ✅ Should set correct success and cancel URLs

**Handle Webhook:**
- ✅ Should process subscription created event
- ✅ Should process subscription canceled event
- ✅ Should process subscription updated event
- ✅ Should verify webhook signature
- ✅ Should handle idempotency (duplicate events)
- ✅ Should log all webhook events

### Stripe Provider Tests (`infrastructure/payment/__tests__/providers/StripeProvider.test.ts`)

- ✅ Should create checkout session
- ✅ Should verify webhook signature
- ✅ Should handle Stripe API errors
- ✅ Should construct event from webhook payload

### API Route Tests (`app/api/__tests__/payments/webhook.test.ts`)

- ✅ Should process valid webhook event
- ✅ Should return 400 for invalid signature
- ✅ Should handle idempotency
- ✅ Should return 200 for processed events
- ✅ Should log webhook processing

## Feature 7: Gallery (Public Sharing)

### Gallery Service Tests (`domain/testimony/__tests__/GalleryService.test.ts`)

**Publish to Gallery:**
- ✅ Should publish testimony to gallery when user consents
- ✅ Should throw error when user does not own testimony
- ✅ Should enforce rate limit on gallery submissions
- ✅ Should require explicit user consent

**Remove from Gallery:**
- ✅ Should remove testimony from gallery when user owns it
- ✅ Should throw error when user does not own gallery entry

**List Public Entries:**
- ✅ Should return all public gallery entries
- ✅ Should paginate results
- ✅ Should filter by framework type (optional)
- ✅ Should exclude private testimonies

### API Route Tests (`app/api/__tests__/gallery.test.ts`)

**POST /api/gallery/publish:**
- ✅ Should publish testimony to gallery
- ✅ Should return 403 when user does not own testimony
- ✅ Should return 400 when displayName is missing
- ✅ Should return 429 when rate limit exceeded

**DELETE /api/gallery/:id:**
- ✅ Should remove testimony from gallery
- ✅ Should return 403 when user does not own entry

**GET /api/gallery:**
- ✅ Should return public gallery entries
- ✅ Should paginate results
- ✅ Should support filtering
- ✅ Should not require authentication

## Feature 8: Subscription Management

### Subscription Service Tests (`domain/subscription/__tests__/SubscriptionService.test.ts`)

- ✅ Should check if user has active subscription
- ✅ Should create subscription from Stripe webhook
- ✅ Should cancel subscription
- ✅ Should update subscription status
- ✅ Should return subscription details
- ✅ Should handle expired subscriptions

### API Route Tests (`app/api/__tests__/subscription.test.ts`)

- ✅ Should return subscription status for authenticated user
- ✅ Should return 401 for unauthenticated requests
- ✅ Should return null when user has no subscription

## Feature 9: Preview Functionality

### Component Tests (`components/__tests__/TestimonyPreview.test.tsx`)

- ✅ Should render testimony title
- ✅ Should render testimony content based on framework
- ✅ Should format BeforeEncounterAfter content
- ✅ Should format LifeTimeline content
- ✅ Should format SeasonsOfGrowth content
- ✅ Should format FreeFormNarrative content
- ✅ Should show export button
- ✅ Should show edit button (when user owns it)
- ✅ Should show share to gallery button (when user owns it)
- ✅ Should not show edit button for other users' testimonies

## Feature 10: Dashboard

### Component Tests (`components/__tests__/Dashboard.test.tsx`)

- ✅ Should display user's testimonies
- ✅ Should show empty state when no testimonies
- ✅ Should allow creating new testimony
- ✅ Should allow editing existing testimony
- ✅ Should allow deleting testimony
- ✅ Should show testimony preview
- ✅ Should filter testimonies by framework
- ✅ Should search testimonies by title
- ✅ Should paginate testimonies list

## Test Implementation Strategy

### Phase 1: Setup & Authentication
1. Write tests for magic link authentication
2. Implement authentication features
3. Refactor and add edge cases

### Phase 2: Core Testimony Features
1. Write domain tests for testimony CRUD
2. Write repository tests
3. Write API route tests
4. Write component tests
5. Implement features following TDD cycle

### Phase 3: Framework Components
1. Write tests for each framework component
2. Implement framework components
3. Test framework switching and data persistence

### Phase 4: Export & Premium Features
1. Write tests for PDF export
2. Write tests for AI editing
3. Write tests for payment integration
4. Implement features following TDD cycle

### Phase 5: Gallery & Polish
1. Write tests for gallery features
2. Write tests for dashboard
3. Implement features following TDD cycle
4. Integration tests for full user flows

## Coverage Goals

- **Domain Layer**: 90%+ coverage
- **Infrastructure Layer**: 80%+ coverage
- **API Routes**: 80%+ coverage
- **Components**: 70%+ coverage (focus on user interactions)
- **Critical Paths**: 100% coverage (authentication, payments, data access)

## Continuous Testing

- Run tests in watch mode during development
- Run full test suite before commits (pre-commit hook)
- Run tests in CI/CD pipeline (Vercel)
- Fail builds if tests fail or coverage drops below threshold
- Generate coverage reports for each PR

